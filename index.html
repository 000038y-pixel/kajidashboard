<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>家事ダッシュボード</title>

<style>
body {
font-family: -apple-system, BlinkMacSystemFont, sans-serif;
background: #f2f2f7;
margin: 0;
padding: 12px;
}

h1 { font-size: 18px; }
h2 { font-size: 14px; margin-top: 16px; color: #555; }

.grid {
display: grid;
grid-template-columns: repeat(4, 1fr);
gap: 8px;
}

.chore {
background: #fff;
border-radius: 8px;
padding: 6px 4px;
text-align: center;
box-shadow: 0 1px 2px rgba(0,0,0,0.1);
font-size: 11px;
user-select: none;
}

.chore.done {
background: #1c1c1e;
color: #fff;
}

.chore.overdue {
background: #ff3b30;
color: #fff;
}

.add-button {
margin: 16px 0;
padding: 8px;
text-align: center;
background: #e5e5ea;
color: #555;
border-radius: 8px;
font-size: 12px;
}
</style>
</head>

<body>

<h1>家事ダッシュボード</h1>
<div id="app"></div>
<div class="add-button" onclick="addChore()">＋ 家事を追加</div>

<script>
const groups = [
{ title: "7日以内", days: 7 },
{ title: "1ヶ月以内", days: 30 },
{ title: "3ヶ月以内", days: 90 }
];

let chores = JSON.parse(localStorage.getItem("chores")) || [];
let pressTimer = null;

/* ===== 危険度計算 ===== */
function getDangerScore(chore) {
if (!chore.lastDone) return 3; // 未実施

const now = new Date();
const last = new Date(chore.lastDone);
const limit = new Date(last);
limit.setDate(limit.getDate() + groups[chore.group].days);

if (now <= limit) return 2; // 期限内

const overdueDays = Math.floor((now - limit) / 86400000);
if (overdueDays >= 7) return 0; // 最危険

return 1; // 期限切れ
}

function getStatus(chore) {
const score = getDangerScore(chore);
if (score === 0) return "overdue";
if (score === 2) return "done";
return "none";
}

function formatDate(dateString) {
if (!dateString) return "未実施";
const d = new Date(dateString);
return `${d.getMonth()+1}/${d.getDate()}`;
}

/* ===== 描画 ===== */
function render() {
const app = document.getElementById("app");
app.innerHTML = "";

groups.forEach((group, gIndex) => {
const h2 = document.createElement("h2");
h2.textContent = group.title;
app.appendChild(h2);

const grid = document.createElement("div");
grid.className = "grid";

const filtered = chores
.map((c, i) => ({ ...c, index: i }))
.filter(c => c.group === gIndex)
.sort((a, b) => getDangerScore(a) - getDangerScore(b));

filtered.forEach(item => {
const div = document.createElement("div");
const status = getStatus(item);

div.className = "chore";
if (status === "done") div.classList.add("done");
if (status === "overdue") div.classList.add("overdue");

div.innerHTML = `
<div>${item.name}</div>
<div style="font-size:10px;opacity:0.8">${formatDate(item.lastDone)}</div>
`;

/* タップ */
div.onclick = () => {
chores[item.index].lastDone = new Date().toISOString();
save();
};

/* 長押し編集 */
div.ontouchstart = () => {
pressTimer = setTimeout(() => openEditMenu(item.index), 800);
};
div.ontouchend = () => clearTimeout(pressTimer);

grid.appendChild(div);
});

app.appendChild(grid);
});
}

/* ===== 編集 ===== */
function openEditMenu(index) {
const choice = prompt(
"編集\n1:名前変更\n2:グループ変更\n3:削除"
);

if (choice === "1") {
const n = prompt("新しい名前", chores[index].name);
if (n) chores[index].name = n;
}
if (choice === "2") {
const g = prompt("0:7日 1:1ヶ月 2:3ヶ月");
if (["0","1","2"].includes(g)) chores[index].group = Number(g);
}
if (choice === "3") {
if (!confirm("削除しますか？")) return;
chores.splice(index, 1);
}
save();
}

/* ===== 追加 ===== */
function addChore() {
const name = prompt("家事名");
if (!name) return;

const g = prompt("0:7日 1:1ヶ月 2:3ヶ月");
if (!["0","1","2"].includes(g)) return;

chores.push({ name, group: Number(g), lastDone: null });
save();
}

function save() {
localStorage.setItem("chores", JSON.stringify(chores));
render();
}

render();
</script>

</body>
</html>
